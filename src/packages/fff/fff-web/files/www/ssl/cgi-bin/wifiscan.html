#!/usr/bin/haserl

<%in /www/ssl/cgi-bin/header %>
<%
readIWinfo() {
	local iface=$1
	local ssid=$2
	local mac=$3

	iwinfo "$iface" scan |\
		awk -v RS='' \
		'{r = gensub(/.*Address: ([0-9A-F:]*)?.*ESSID: "?(unknown|[^"]*)"?[ ]*\n.*Mode: ([^ ]*).*Channel: ([0-9]*).*Signal: (-[0-9]*) dBm.*Encryption: ([^"]*).*/, \
		"<!-- \\5 --><tr><'${ssid}'>\\2</'${ssid}'><td>\\4</td><td>\\5 dBm</td><td>\\3</td><'${mac}'>\\1</'${mac}'><td>\\6</td></tr>", "g"); print r;}' | sort -n | sed 's#&#\&amp;#'
		# The HTML comment contains the signal quality to allow sorting
}
printWifiScan() {
	local iface=$1
	local freq="2.4 GHz"
	if [ "$iface" = "w5ap" ] || [ "$iface" = "w5mesh" ] ; then
		freq="5 GHz"
	fi
%>
	<tr><td>
	<fieldset>
		<legend>Wifi Scan: <%= "$freq" %></legend>
		<table class="wifitable">
			<tr>
				<th>Name</th>
				<th>Kanal</th>
				<th>Signal</th>
				<th>Typ</th>
				<th>MAC</th>
				<th>Encryption</th>
			</tr>

<%
	readIWinfo "$iface" "td" "td"
%>
		</table>
	</fieldset>
	</td></tr>
<%
}

%>
<table style="width: 100%">
<%
if uci -q get wireless.w2ap > /dev/null ; then
	printWifiScan "w2ap"
fi
if uci -q get wireless.w5ap > /dev/null ; then
	printWifiScan "w5ap"
fi
%>
</table>

<%in /www/ssl/cgi-bin/footer %>
